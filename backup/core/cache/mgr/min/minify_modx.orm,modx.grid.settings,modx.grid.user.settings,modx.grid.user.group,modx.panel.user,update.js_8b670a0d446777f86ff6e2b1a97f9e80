Ext.ns('MODx.orm');MODx.orm.Tree=function(config){config=config||{};Ext.applyIf(config,{height:300,width:400,useArrows:true,autoScroll:true,animate:true,enableDD:false,border:false,containerScroll:true,rootVisible:false,root:new Ext.tree.AsyncTreeNode({expanded:true,children:config.data,listeners:{'load':{fn:function(){this.expandAll();},scope:this}}}),tbar:[{text:_('orm_attribute_add'),handler:function(btn,e){this.addAttribute(btn,e);},scope:this},{text:_('orm_container_add'),handler:function(btn,e){this.addContainer(btn,e);},scope:this}],menuConfig:{defaultAlign:'tl-b?',enableScrolling:false}});MODx.orm.Tree.superclass.constructor.call(this,config);this.config=config;this.on('click',this.onClick,this);this.on('contextmenu',this._showContextMenu,this);this.cm=new Ext.menu.Menu(config.menuConfig);};Ext.extend(MODx.orm.Tree,Ext.tree.TreePanel,{windows:{},getSelectedNode:function(){return this.getSelectionModel().getSelectedNode();},addContextMenuItem:function(items){var a=items,l=a.length;for(var i=0;i<l;i++){a[i].scope=this;this.cm.add(a[i]);}},_showContextMenu:function(node,e){node.select();this.cm.activeNode=node;this.cm.removeAll();var m=[];if(node.attributes.leaf){m.push({text:_('orm_attribute_remove'),handler:this.removeAttribute,scope:this});}else{m.push({text:_('orm_attribute_add_below'),handler:function(itm,e){this.addAttribute(itm,e,this.cm.activeNode);},scope:this});m.push({text:_('orm_container_add_below'),handler:function(itm,e){this.addContainer(itm,e,this.cm.activeNode);},scope:this});m.push('-');m.push({text:_('orm_container_rename'),handler:function(itm,e){this.renameContainer(itm,e,this.cm.activeNode);},scope:this});m.push('-');m.push({text:_('orm_container_remove'),handler:this.removeContainer,scope:this});}
if(m.length>0){this.addContextMenuItem(m);this.cm.showAt(e.xy);}
e.stopEvent();},markFormPanelDirty:function(f){var fp=Ext.getCmp(f?f:this.config.formPanel);if(fp){fp.markDirty();}},removeAttribute:function(btn,e){var n=this.getSelectedNode();if(n){Ext.Msg.confirm(_('orm_attribute_remove'),_('orm_attribute_remove_confirm'),function(e){if(e=='yes'){n.remove();this.markFormPanelDirty();}},this);}},removeContainer:function(btn,e){var n=this.getSelectedNode();if(n){Ext.Msg.confirm(_('orm_container_remove'),_('orm_container_remove_confirm'),function(e){if(e=='yes'){n.remove();this.markFormPanelDirty();}},this);}},addContainer:function(btn,e,node){var r={};if(node){r.parent=node.id;}
if(!this.windows.addContainer){this.windows.addContainer=MODx.load({xtype:'modx-orm-window-container-add',record:r,tree:this,listeners:{'success':{fn:function(r){var n=new Ext.tree.TreeNode({text:r.name,id:r.name,name:r.name,expanded:true,expandable:true,leaf:false});var nd=this.getSelectedNode();var pn=nd&&!nd.attributes.value?nd:this.getRootNode();pn.appendChild(n);this.markFormPanelDirty();},scope:this}}});}
this.windows.addContainer.setValues(r);this.windows.addContainer.show(e.target);},renameContainer:function(btn,e,node){var r={};if(node){r.parent=node.id;}
if(!this.windows.renameContainer){this.windows.renameContainer=MODx.load({xtype:'modx-orm-window-container-rename',record:r,listeners:{'success':{fn:function(r){var nd=this.getSelectedNode();nd.setId(r.name);nd.setText(r.name);this.markFormPanelDirty();},scope:this}}});}
this.windows.renameContainer.setValues(r);this.windows.renameContainer.show(e.target);},addAttribute:function(btn,e,node){var r={};if(node){r.parent=node.id;}
if(!this.windows.addAttribute){this.windows.addAttribute=MODx.load({xtype:'modx-orm-window-attribute-add',record:r,tree:this,listeners:{'success':{fn:function(r){var n=new Ext.tree.TreeNode({text:r.name+' - <i>'+r.value+'</i>',id:r.id,name:r.name,leaf:true,value:r.value});var nd=this.getSelectedNode();var pn=nd&&!nd.attributes.value?nd:this.getRootNode();pn.appendChild(n);this.markFormPanelDirty();},scope:this}}});}
this.windows.addAttribute.setValues(r);this.windows.addAttribute.show(e.target);},encode:function(node){if(!node){node=this.getRootNode();}
var _encode=function(node){var resultNode={};var kids=node.childNodes;for(var i=0;i<kids.length;i=i+1){var n=kids[i];var c=_encode(n);if(n.attributes.value!=null&&n.attributes.value!=undefined){resultNode[n.attributes.name]=n.attributes.value;}else{resultNode[n.attributes.name]=c;}}
return resultNode;};var nodes=_encode(node);return Ext.encode(nodes);},onClick:function(n){var vs=n.attributes;if(vs.value!=null&&vs.value!=undefined){var f=Ext.getCmp(this.config.formPanel).getForm();f.findField(this.config.prefix+'_id').setValue(vs.id);f.findField(this.config.prefix+'_name').setValue(vs.name);f.findField(this.config.prefix+'_value').setValue(vs.value);}},childExistsOnSelected:function(id){var n=this.getSelectedNode();var c;if(Ext.isEmpty(n)){c=this.getNodeById(id);if(c&&!Ext.isEmpty(c.parentNode.text)){c=null;}}else{c=n.findChild('id',id);}
if(!Ext.isEmpty(c)){return true;}
return false;}});Ext.reg('modx-orm-tree',MODx.orm.Tree);MODx.orm.Form=function(config){Ext.applyIf(config,{layout:'form',xtype:'fieldset',labelWidth:150,autoHeight:true,border:false,bodyStyle:'padding: 15px 0;',defaults:{msgTarget:'side',border:false},buttonAlign:'right',items:[{xtype:'textfield',name:config.prefix+'_name',fieldLabel:_('name'),anchor:'100%'},{xtype:'textfield',name:config.prefix+'_value',fieldLabel:_('value'),anchor:'100%'},{xtype:'hidden',name:config.prefix+'_id'}],buttons:[{text:_('set'),cls:'primary-button',handler:this.saveProperty,scope:this}]});MODx.orm.Form.superclass.constructor.call(this,config);this.config=config;}
Ext.extend(MODx.orm.Form,Ext.Panel,{saveProperty:function(){var fp=Ext.getCmp(this.config.formPanel);var t=Ext.getCmp(this.config.treePanel);if(!fp||!t)return false;var f=fp.getForm();var n=t.getSelectionModel().getSelectedNode();var txt=f.findField(this.config.prefix+'_name').getValue();var val=f.findField(this.config.prefix+'_value').getValue();n.attributes.id=f.findField(this.config.prefix+'_id').getValue();n.attributes.text=txt;n.attributes.value=val;n.setText(txt+' - <i>'+Ext.util.Format.ellipsis(val,33)+'</i>');fp.markDirty();return true;}});Ext.reg('modx-orm-form',MODx.orm.Form);MODx.window.AddOrmAttribute=function(config){config=config||{};this.ident=config.ident||'ormcattr'+Ext.id();Ext.applyIf(config,{title:_('orm_attribute_add'),id:this.ident,fields:[{xtype:'hidden',name:'parent',value:0},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:'modx-'+this.ident+'-name',anchor:'100%',allowBlank:false},{xtype:'textfield',fieldLabel:_('value'),name:'value',id:'modx-'+this.ident+'-value',anchor:'100%'}]});MODx.window.AddOrmAttribute.superclass.constructor.call(this,config);};Ext.extend(MODx.window.AddOrmAttribute,MODx.Window,{submit:function(){var v=this.fp.getForm().getValues();if(this.config.tree.childExistsOnSelected(v.name)){this.fp.getForm().markInvalid({name:_('orm_attribute_ae')});return false;}
if(this.fp.getForm().isValid()){if(this.fireEvent('success',v)){this.fp.getForm().reset();this.hide();return true;}}
return false;}});Ext.reg('modx-orm-window-attribute-add',MODx.window.AddOrmAttribute);MODx.window.AddOrmContainer=function(config){config=config||{};this.ident=config.ident||'ormccont'+Ext.id();Ext.applyIf(config,{title:_('orm_container_add'),id:this.ident,fields:[{xtype:'hidden',name:'parent',value:0},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:'modx-'+this.ident+'-name',anchor:'100%',allowBlank:false}]});MODx.window.AddOrmContainer.superclass.constructor.call(this,config);};Ext.extend(MODx.window.AddOrmContainer,MODx.Window,{submit:function(){var v=this.fp.getForm().getValues();if(this.config.tree.childExistsOnSelected(v.name)){this.fp.getForm().markInvalid({name:_('orm_attribute_ae')});return false;}
if(this.fp.getForm().isValid()){if(this.fireEvent('success',v)){this.fp.getForm().reset();this.hide();return true;}}
return false;}});Ext.reg('modx-orm-window-container-add',MODx.window.AddOrmContainer);MODx.window.RenameOrmContainer=function(config){config=config||{};this.ident=config.ident||'ormrcont'+Ext.id();Ext.applyIf(config,{title:_('orm_container_rename'),id:this.ident,fields:[{xtype:'hidden',name:'parent',value:0},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:'modx-'+this.ident+'-name',anchor:'100%',allowBlank:false}]});MODx.window.RenameOrmContainer.superclass.constructor.call(this,config);};Ext.extend(MODx.window.RenameOrmContainer,MODx.Window,{submit:function(){var v=this.fp.getForm().getValues();if(this.fp.getForm().isValid()){if(this.fireEvent('success',v)){this.fp.getForm().reset();this.hide();return true;}}
return false;}});Ext.reg('modx-orm-window-container-rename',MODx.window.RenameOrmContainer);;MODx.grid.SettingsGrid=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{description_trans}</p>')});if(!config.tbar){config.tbar=[{text:_('setting_create'),scope:this,cls:'primary-button',handler:{xtype:'modx-window-setting-create',url:config.url||MODx.config.connector_url,blankValues:true}}];}
config.tbar.push('->',{xtype:'modx-combo-namespace',name:'namespace',id:'modx-filter-namespace',emptyText:_('namespace_filter'),value:MODx.request['ns']?MODx.request['ns']:'core',allowBlank:true,editable:true,typeAhead:true,forceSelection:true,queryParam:'search',width:150,listeners:{'select':{fn:this.filterByNamespace,scope:this}}},{xtype:'modx-combo-area',name:'area',id:'modx-filter-area',emptyText:_('area_filter'),value:MODx.request['area'],baseParams:{action:'system/settings/getAreas',namespace:MODx.request['ns']?MODx.request['ns']:'core'},width:250,allowBlank:true,editable:true,typeAhead:true,forceSelection:true,listeners:{'select':{fn:this.filterByArea,scope:this}}},{xtype:'textfield',name:'filter_key',id:'modx-filter-key',cls:'x-form-filter',emptyText:_('search_by_key')+'...',listeners:{'change':{fn:this.filterByKey,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp});},scope:this}}},{xtype:'button',id:'modx-filter-clear',cls:'x-form-filter-clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}});this.cm=new Ext.grid.ColumnModel({columns:[this.exp,{header:_('name'),dataIndex:'name_trans',sortable:true,editable:false,width:175},{header:_('key'),dataIndex:'key',sortable:true,editable:false,width:150},{header:_('value'),dataIndex:'value',sortable:true,editable:true,renderer:this.renderDynField.createDelegate(this,[this],true),width:260},{header:_('last_modified'),dataIndex:'editedon',sortable:true,editable:false,width:100},{header:_('area'),dataIndex:'area_text',sortable:true,hidden:true,editable:false}],getCellEditor:function(colIndex,rowIndex){var field=this.getDataIndex(colIndex);if(field=='value'){var rec=config.store.getAt(rowIndex);var xt={xtype:'textfield'};if(rec){xt.xtype=rec.get('xtype');if(xt=='text-password'){xt.xtype='textfield';xt.inputType='password';}}
var o=MODx.load(xt);return new Ext.grid.GridEditor(o);}
return Ext.grid.ColumnModel.prototype.getCellEditor.call(this,colIndex,rowIndex);}});Ext.applyIf(config,{cm:this.cm,fields:['key','name','value','description','xtype','namespace','area','area_text','editedon','oldkey','menu','name_trans','description_trans'],url:MODx.config.connector_url,baseParams:{action:'system/settings/getList',namespace:MODx.request['ns']?MODx.request['ns']:'core',area:MODx.request['area']},clicksToEdit:2,grouping:true,groupBy:'area_text',singleText:_('setting'),pluralText:_('settings'),sortBy:'key',plugins:this.exp,primaryKey:'key',autosave:true,save_action:'system/settings/updatefromgrid',pageSize:MODx.config.default_per_page>30?MODx.config.default_per_page:30,paging:true,collapseFirst:false,tools:[{id:'plus',qtip:_('expand_all'),handler:this.expandAll,scope:this},{id:'minus',hidden:true,qtip:_('collapse_all'),handler:this.collapseAll,scope:this}]});this.view=new Ext.grid.GroupingView({emptyText:config.emptyText||_('ext_emptymsg'),forceFit:true,autoFill:true,showPreview:true,enableRowBody:true,scrollOffset:0});MODx.grid.SettingsGrid.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.SettingsGrid,MODx.grid.Grid,{_addEnterKeyHandler:function(){this.getEl().addKeyListener(Ext.EventObject.ENTER,function(){this.fireEvent('change');},this);},_showMenu:function(g,ri,e){e.stopEvent();e.preventDefault();this.menu.record=this.getStore().getAt(ri).data;if(!this.getSelectionModel().isSelected(ri)){this.getSelectionModel().selectRow(ri);}
this.menu.removeAll();var m=[];if(this.menu.record.menu){m=this.menu.record.menu;}else{m.push({text:_('setting_update'),handler:this.updateSetting},'-',{text:_('setting_remove'),handler:this.remove.createDelegate(this,['setting_remove_confirm','system/settings/remove'])});}
if(m.length>0){this.addContextMenuItem(m);this.menu.showAt(e.xy);}},updateSetting:function(btn,e){var r=this.menu.record;r.fk=Ext.isDefined(this.config.fk)?this.config.fk:0;var uss=MODx.load({xtype:'modx-window-setting-update',record:r,grid:this,listeners:{'success':{fn:function(r){this.refresh();},scope:this}}});uss.reset();uss.setValues(r);uss.show(e.target);},clearFilter:function(){var ns=MODx.request['ns']?MODx.request['ns']:'core';var area=MODx.request['area']?MODx.request['area']:'';this.getStore().baseParams=this.initialConfig.baseParams;var acb=Ext.getCmp('modx-filter-area');if(acb){acb.store.baseParams['namespace']=ns;acb.store.load();acb.reset();}
Ext.getCmp('modx-filter-namespace').reset();Ext.getCmp('modx-filter-key').reset();this.getStore().baseParams.namespace=ns;this.getStore().baseParams.area=area;this.getStore().baseParams.key='';this.getBottomToolbar().changePage(1);this.refresh();},filterByKey:function(tf,newValue,oldValue){this.getStore().baseParams.key=newValue;this.getStore().baseParams.namespace='';this.getBottomToolbar().changePage(1);this.refresh();return true;},filterByNamespace:function(cb,rec,ri){this.getStore().baseParams['namespace']=rec.data['name'];this.getStore().baseParams['area']='';this.getBottomToolbar().changePage(1);this.refresh();var acb=Ext.getCmp('modx-filter-area');if(acb){var s=acb.store;s.baseParams['namespace']=rec.data.name;s.removeAll();s.load();acb.setValue('');}},filterByArea:function(cb,rec,ri){this.getStore().baseParams['area']=rec.data['v'];this.getBottomToolbar().changePage(1);this.refresh();},renderDynField:function(v,md,rec,ri,ci,s,g){var r=s.getAt(ri).data;v=Ext.util.Format.htmlEncode(v);var f;if(r.xtype=='combo-boolean'||r.xtype=='modx-combo-boolean'){f=MODx.grid.Grid.prototype.rendYesNo;return f(v,md,rec,ri,ci,s,g);}else if(r.xtype==='datefield'){f=Ext.util.Format.dateRenderer('Y-m-d');return f(v,md,rec,ri,ci,s,g);}else if(r.xtype==='text-password'||r.xtype=='modx-text-password'){f=MODx.grid.Grid.prototype.rendPassword;return f(v,md,rec,ri,ci,s,g);}else if(r.xtype.substr(0,5)=='combo'||r.xtype.substr(0,10)=='modx-combo'){var cm=g.getColumnModel();var ed=cm.getCellEditor(ci,ri);if(!ed){var o=Ext.ComponentMgr.create({xtype:r.xtype||'textfield'});ed=new Ext.grid.GridEditor(o);cm.setEditor(ci,ed);}
if(ed.store&&!ed.store.isLoaded&&ed.config.mode!='local'){ed.store.load();ed.store.isLoaded=true;}
f=Ext.util.Format.comboRenderer(ed.field,v);return f(v,md,rec,ri,ci,s,g);}
return v;}});Ext.reg('modx-grid-settings',MODx.grid.SettingsGrid);MODx.combo.Area=function(config){config=config||{};Ext.applyIf(config,{name:'area',hiddenName:'area',displayField:'d',valueField:'v',fields:['d','v'],url:MODx.config.connector_url,baseParams:{action:'system/settings/getAreas'}});MODx.combo.Area.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.Area,MODx.combo.ComboBox);Ext.reg('modx-combo-area',MODx.combo.Area);MODx.window.CreateSetting=function(config){config=config||{};Ext.applyIf(config,{title:_('setting_create'),width:600,url:config.url,action:'system/settings/create',fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false},items:[{columnWidth:.5,items:[{xtype:'hidden',name:'fk',id:'modx-cs-fk',value:config.fk||0},{xtype:'textfield',fieldLabel:_('key'),name:'key',id:'modx-cs-key',maxLength:100,anchor:'100%'},{xtype:'label',forId:'modx-cs-key',html:_('key_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('name'),name:'name',id:'modx-cs-name',anchor:'100%'},{xtype:'label',forId:'modx-cs-name',html:_('name_desc'),cls:'desc-under'},{xtype:'textarea',fieldLabel:_('description'),name:'description',id:'modx-cs-description',allowBlank:true,anchor:'100%'},{xtype:'label',forId:'modx-cs-description',html:_('description_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'modx-combo-xtype-spec',fieldLabel:_('xtype'),description:MODx.expandHelp?'':_('xtype_desc'),id:'modx-cs-xtype',anchor:'100%'},{xtype:'label',forId:'modx-cs-xtype',html:_('xtype_desc'),cls:'desc-under'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),name:'namespace',id:'modx-cs-namespace',value:'core',anchor:'100%'},{xtype:'label',forId:'modx-cs-namespace',html:_('namespace_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('area_lexicon_string'),description:_('area_lexicon_string_msg'),name:'area',id:'modx-cs-area',anchor:'100%'},{xtype:'label',forId:'modx-cs-area',html:_('area_lexicon_string_msg'),cls:'desc-under'}]}]},{xtype:'textarea',fieldLabel:_('value'),name:'value',id:'modx-cs-value',anchor:'100%'}],keys:[]});MODx.window.CreateSetting.superclass.constructor.call(this,config);this.on('show',function(){this.reset();this.setValues({namespace:Ext.getCmp('modx-filter-namespace').value,area:Ext.getCmp('modx-filter-area').value});},this);};Ext.extend(MODx.window.CreateSetting,MODx.Window);Ext.reg('modx-window-setting-create',MODx.window.CreateSetting);MODx.combo.xType=function(config){config=config||{};Ext.applyIf(config,{store:new Ext.data.SimpleStore({fields:['d','v'],data:[[_('textfield'),'textfield'],[_('textarea'),'textarea'],[_('yesno'),'combo-boolean'],[_('password'),'text-password'],[_('category'),'modx-combo-category'],[_('charset'),'modx-combo-charset'],[_('country'),'modx-combo-country'],[_('context'),'modx-combo-context'],[_('namespace'),'modx-combo-namespace'],[_('template'),'modx-combo-template'],[_('user'),'modx-combo-user'],[_('usergroup'),'modx-combo-usergroup'],[_('language'),'modx-combo-language'],[_('source'),'modx-combo-source'],[_('setting_manager_theme'),'modx-combo-manager-theme']]}),displayField:'d',valueField:'v',mode:'local',name:'xtype',hiddenName:'xtype',triggerAction:'all',editable:false,selectOnFocus:false,value:'textfield'});MODx.combo.xType.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.xType,Ext.form.ComboBox);Ext.reg('modx-combo-xtype-spec',MODx.combo.xType);MODx.window.UpdateSetting=function(config){config=config||{};this.ident=config.ident||'modx-uss-'+Ext.id();Ext.applyIf(config,{title:_('setting_update'),width:600,url:config.grid.config.url,action:'system/settings/update',fields:[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',anchor:'100%',border:false},items:[{columnWidth:.5,items:[{xtype:'hidden',name:'fk',id:'modx-'+this.ident+'-fk',value:config.fk||0},{xtype:'statictextfield',fieldLabel:_('key'),description:MODx.expandHelp?'':_('key_desc'),name:'key',id:'modx-'+this.ident+'-key',maxLength:100,submitValue:true,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-key',html:_('key_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('name'),description:MODx.expandHelp?'':_('name_desc'),name:'name',id:'modx-'+this.ident+'-name',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-name',html:_('name_desc'),cls:'desc-under'},{xtype:'textarea',fieldLabel:_('description'),description:MODx.expandHelp?'':_('description_desc'),name:'description',id:'modx-'+this.ident+'-description',allowBlank:true,anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-description',html:_('description_desc'),cls:'desc-under'}]},{columnWidth:.5,items:[{xtype:'modx-combo-xtype-spec',fieldLabel:_('xtype'),description:MODx.expandHelp?'':_('xtype_desc'),id:'modx-'+this.ident+'-xtype',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-xtype',html:_('xtype_desc'),cls:'desc-under'},{xtype:'modx-combo-namespace',fieldLabel:_('namespace'),description:MODx.expandHelp?'':_('namespace_desc'),name:'namespace',id:'modx-'+this.ident+'-namespace',value:'core',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-namespace',html:_('namespace_desc'),cls:'desc-under'},{xtype:'textfield',fieldLabel:_('area_lexicon_string'),description:MODx.expandHelp?'':_('area_lexicon_string_msg'),name:'area',id:'modx-'+this.ident+'-area',anchor:'100%'},{xtype:MODx.expandHelp?'label':'hidden',forId:'modx-'+this.ident+'-area',html:_('area_lexicon_string_msg'),cls:'desc-under'}]}]},{xtype:config.record?config.record.xtype:'textarea',fieldLabel:_('value'),name:'value',hiddenName:'value',id:'modx-'+this.ident+'-value',anchor:'100%'}],keys:[]});MODx.window.UpdateSetting.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateSetting,MODx.Window);Ext.reg('modx-window-setting-update',MODx.window.UpdateSetting);;MODx.grid.UserSettings=function(config){config=config||{};Ext.applyIf(config,{title:_('user_settings'),id:'modx-grid-user-settings',url:MODx.config.connector_url,baseParams:{action:'security/user/setting/getList',user:config.user},saveParams:{user:config.user},save_action:'security/user/setting/updatefromgrid',fk:config.user,tbar:[{text:_('create_new'),cls:'primary-button',scope:this,handler:{xtype:'modx-window-setting-create',url:MODx.config.connector_url,baseParams:{action:'security/user/setting/create'},fk:config.user}}]});MODx.grid.UserSettings.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.UserSettings,MODx.grid.SettingsGrid);Ext.reg('modx-grid-user-settings',MODx.grid.UserSettings);;MODx.grid.UserGroups=function(config){config=config||{};Ext.applyIf(config,{title:'',id:'modx-grid-user-groups',url:MODx.config.connector_url,baseParams:{action:'security/group/getlist'},fields:['usergroup','name','member','role','rolename','primary_group','rank'],cls:'modx-grid modx-grid-draggable',columns:[{header:_('user_group'),dataIndex:'name',width:175},{header:_('role'),dataIndex:'rolename',width:175},{header:_('rank'),dataIndex:'rank',width:80,editor:{xtype:'numberfield',allowBlank:false,allowNegative:false}}],plugins:[new Ext.ux.dd.GridDragDropRowOrder({copy:false,scrollable:true,targetCfg:{},listeners:{'afterrowmove':{fn:this.onAfterRowMove,scope:this},'beforerowmove':{fn:this.onBeforeRowMove,scope:this}}})],tbar:[{text:_('user_group_user_add'),cls:'primary-button',handler:this.addGroup}]});MODx.grid.UserGroups.superclass.constructor.call(this,config);this.userRecord=new Ext.data.Record.create(['usergroup','name','member','role','rolename','primary_group']);this.addEvents('beforeUpdateRole','afterUpdateRole','beforeAddGroup','afterAddGroup','beforeReorderGroup','afterReorderGroup');};Ext.extend(MODx.grid.UserGroups,MODx.grid.LocalGrid,{onBeforeRowMove:function(dt,sri,ri,sels){if(!this.fireEvent('beforeReorderGroup',{dt:dt,sri:sri,ri:ri,sels:sels})){return false;}
return true;},onAfterRowMove:function(dt,sri,ri,sels){var s=this.getStore();var sourceRec=s.getAt(sri);var belowRec=s.getAt(ri);var total=s.getTotalCount();sourceRec.set('rank',sri);sourceRec.commit();var brec;for(var x=(ri-1);x<total;x++){brec=s.getAt(x);if(brec){brec.set('rank',x);brec.commit();}}
this.fireEvent('afterReorderGroup');return true;},updateRole:function(btn,e){var r=this.menu.record;r.user=this.config.user;this.fireEvent('beforeUpdateRole',r);this.loadWindow(btn,e,{xtype:'modx-window-user-groups-role-update',record:r,listeners:{'success':{fn:function(r){var s=this.getStore();var rec=s.getAt(this.menu.recordIndex);rec.set('role',r.role);rec.set('rolename',r.rolename);this.fireEvent('afterUpdateRole',r);},scope:this}}});},addGroup:function(btn,e){var r={member:this.config.user};this.fireEvent('beforeUpdateRole',r);this.loadWindow(btn,e,{xtype:'modx-window-user-addgroup',record:r,listeners:{'success':{fn:function(r){var s=this.getStore();var rec=new this.userRecord(r);s.add(rec);this.fireEvent('afterAddGroup',r);},scope:this}}});},_showMenu:function(g,ri,e){e.stopEvent();e.preventDefault();var m=this.menu;m.recordIndex=ri;m.record=this.getStore().getAt(ri).data;if(!this.getSelectionModel().isSelected(ri)){this.getSelectionModel().selectRow(ri);}
m.removeAll();m.add({text:_('user_role_update'),handler:this.updateRole,scope:this},'-',{text:_('user_group_user_remove'),handler:this.remove.createDelegate(this,[{text:_('user_group_remove_confirm')}]),scope:this});m.show(e.target);}});Ext.reg('modx-grid-user-groups',MODx.grid.UserGroups);MODx.window.AddGroupToUser=function(config){config=config||{};Ext.applyIf(config,{title:_('user_group_user_add'),url:MODx.config.connector_url,action:'security/group/user/create',fields:[{fieldLabel:_('user_group'),name:'usergroup',hiddenName:'usergroup',id:'modx-agu-usergroup',xtype:'modx-combo-usergroup',editable:false,allowBlank:false,anchor:'100%'},{fieldLabel:_('role'),name:'role',hiddenName:'role',id:'modx-agu-role',xtype:'modx-combo-role',allowBlank:false,anchor:'100%'},{name:'member',xtype:'hidden'}]});MODx.window.AddGroupToUser.superclass.constructor.call(this,config);};Ext.extend(MODx.window.AddGroupToUser,MODx.Window,{submit:function(){var r=this.fp.getForm().getValues();var g=Ext.getCmp('modx-grid-user-groups');var s=g.getStore();var v=s.query('usergroup',r.usergroup).items;if(v.length>0){MODx.msg.alert(_('error'),_('user_err_ae_group'));return false;}
r.rolename=Ext.getCmp('modx-agu-role').getRawValue();r.name=Ext.getCmp('modx-agu-usergroup').getRawValue();this.fireEvent('success',r);this.hide();return false;}});Ext.reg('modx-window-user-addgroup',MODx.window.AddGroupToUser);MODx.window.UpdateUserGroupsRole=function(config){config=config||{};Ext.applyIf(config,{id:'modx-window-user-groups-role-update',title:_('user_group_user_update_role'),url:MODx.config.connector_url,action:'security/group/user/update',fields:[{xtype:'hidden',name:'user',value:config.user},{xtype:'modx-combo-role',id:'modx-uugrs-role',name:'role',fieldLabel:_('role'),anchor:'100%'}]});MODx.window.UpdateUserGroupsRole.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateUserGroupsRole,MODx.Window,{submit:function(){var r=this.fp.getForm().getValues();r.rolename=Ext.getCmp('modx-uugrs-role').getRawValue();this.fireEvent('success',r);this.hide();return false;}});Ext.reg('modx-window-user-groups-role-update',MODx.window.UpdateUserGroupsRole);;MODx.panel.User=function(config){config=config||{};Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{},id:'modx-panel-user',cls:'container',defaults:{collapsible:false,autoHeight:true},bodyStyle:'',items:[{html:'<h2>'+_('user_new')+'</h2>',border:false,cls:'modx-page-header',id:'modx-user-header'},{xtype:'modx-tabs',id:'modx-user-tabs',deferredRender:false,defaults:{autoHeight:true,layout:'form',labelWidth:150,bodyCssClass:'tab-panel-wrapper',layoutOnTabChange:true},items:this.getFields(config)}],useLoadingMask:true,listeners:{'setup':{fn:this.setup,scope:this},'success':{fn:this.success,scope:this},'beforeSubmit':{fn:this.beforeSubmit,scope:this}}});MODx.panel.User.superclass.constructor.call(this,config);Ext.getCmp('modx-user-panel-newpassword').getEl().dom.style.display='none';Ext.getCmp('modx-user-password-genmethod-s').on('check',this.showNewPassword,this);};Ext.extend(MODx.panel.User,MODx.FormPanel,{setup:function(){if(this.config.user===''||this.config.user===0){this.fireEvent('ready');return false;}
MODx.Ajax.request({url:this.config.url,params:{action:'security/user/get',id:this.config.user,getGroups:true},listeners:{'success':{fn:function(r){this.getForm().setValues(r.object);var d=Ext.decode(r.object.groups);var g=Ext.getCmp('modx-grid-user-groups');if(g){var s=g.getStore();if(s){s.loadData(d);}}
Ext.get('modx-user-header').update('<h2>'+_('user')+': '+r.object.username+'</h2>');this.fireEvent('ready',r.object);MODx.fireEvent('ready');},scope:this}}});},beforeSubmit:function(o){var d={};var g=Ext.getCmp('modx-grid-user-settings');if(g){d.settings=g.encodeModified();}
var h=Ext.getCmp('modx-grid-user-groups');if(h){d.groups=h.encode();}
var t=Ext.getCmp('modx-remote-tree');if(t){d.remote_data=t.encode();}
var et=Ext.getCmp('modx-extended-tree');if(et){d.extended=et.encode();}
Ext.apply(o.form.baseParams,d);},success:function(o){var userId=this.config.user;if(Ext.getCmp('modx-user-passwordnotifymethod-s').getValue()===true&&o.result.message!=''){Ext.Msg.hide();Ext.Msg.show({title:_('password_notification'),msg:o.result.message,buttons:Ext.Msg.OK,fn:function(btn){if(userId==0){MODx.loadPage('security/user','id='+o.result.object.id);}
return false;}});this.clearDirty();}else if(userId==0){MODx.loadPage('security/user','id='+o.result.object.id);}},showNewPassword:function(cb,v){var el=Ext.getCmp('modx-user-panel-newpassword').getEl();if(v){el.slideIn('t',{useDisplay:true});}else{el.slideOut('t',{useDisplay:true});}},getFields:function(config){var f=[{title:_('general_information'),defaults:{msgTarget:'side',autoHeight:true},cls:'main-wrapper form-with-labels',labelAlign:'top',items:this.getGeneralFields(config)}];if(config.user!=0){f.push({title:_('settings'),autoHeight:true,defaults:{autoHeight:true},hideMode:'offsets',items:[{html:'<h3>'+_('user_settings')+'</h3><p>'+_('user_settings_desc')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-user-settings',cls:'main-wrapper',preventRender:true,user:config.user,width:'97%',listeners:{'afterAutoSave':{fn:this.markDirty,scope:this}}}]});}
f.push({title:_('access_permissions'),layout:'form',defaults:{border:false,autoHeight:true},hideMode:'offsets',items:[{html:_('access_permissions_user_message'),bodyCssClass:'panel-desc'},{xtype:'modx-grid-user-groups',cls:'main-wrapper',title:'',preventRender:true,user:config.user,width:'97%',listeners:{'afterRemoveRow':{fn:this.markDirty,scope:this},'afterUpdateRole':{fn:this.markDirty,scope:this},'afterAddGroup':{fn:this.markDirty,scope:this},'afterReorderGroup':{fn:this.markDirty,scope:this}}}]});if(config.remoteFields&&config.remoteFields.length){f.push({title:_('remote_data'),layout:'form',defaults:{border:false,autoHeight:true},hideMode:'offsets',items:[{html:'<p>'+_('user_remote_data_msg')+'</p>',bodyCssClass:'panel-desc'},{layout:'column',cls:'main-wrapper',items:[{columnWidth:0.4,title:_('attributes'),layout:'fit',border:false,items:{xtype:'modx-orm-tree',id:'modx-remote-tree',data:config.remoteFields,formPanel:'modx-panel-user',prefix:'remote'}},{xtype:'modx-orm-form',columnWidth:0.6,title:_('editing_form'),id:'modx-remote-form',prefix:'remote',treePanel:'modx-remote-tree',formPanel:'modx-panel-user'}]}]});}
config.extendedFields=config.extendedFields||[];f.push({title:_('extended_fields'),layout:'form',defaults:{border:false,autoHeight:true},hideMode:'offsets',items:[{html:'<p>'+_('extended_fields_msg')+'</p>',bodyCssClass:'panel-desc'},{layout:'column',cls:'main-wrapper',items:[{columnWidth:0.4,title:_('attributes'),layout:'fit',border:false,items:{xtype:'modx-orm-tree',id:'modx-extended-tree',data:config.extendedFields,formPanel:'modx-panel-user',prefix:'extended',enableDD:true,listeners:{'dragdrop':{fn:function(){this.markDirty();},scope:this}}}},{xtype:'modx-orm-form',columnWidth:0.6,title:_('editing_form'),id:'modx-extended-form',prefix:'extended',treePanel:'modx-extended-tree',formPanel:'modx-panel-user'}]}]});return f;},getGeneralFields:function(config){return[{layout:'column',border:false,defaults:{layout:'form',labelAlign:'top',labelSeparator:'',anchor:'100%',border:false},items:[{columnWidth:.5,defaults:{msgTarget:'under'},items:[{id:'modx-user-id',name:'id',xtype:'hidden',value:config.user},{id:'modx-user-username',name:'username',fieldLabel:_('username'),description:_('user_username_desc'),xtype:'textfield',anchor:'100%'},{id:'modx-user-fullname',name:'fullname',fieldLabel:_('user_full_name'),xtype:'textfield',anchor:'100%',maxLength:255},{id:'modx-user-email',name:'email',fieldLabel:_('user_email'),xtype:'textfield',anchor:'100%',maxLength:255,allowBlank:false},{id:'modx-user-phone',name:'phone',fieldLabel:_('user_phone'),xtype:'textfield',width:200,maxLength:255},{id:'modx-user-mobilephone',name:'mobilephone',fieldLabel:_('user_mobile'),xtype:'textfield',width:200,maxLength:255},{id:'modx-user-fax',name:'fax',fieldLabel:_('user_fax'),xtype:'textfield',width:200,maxLength:255},{id:'modx-user-address',name:'address',fieldLabel:_('address'),xtype:'textarea',anchor:'100%',grow:true},{id:'modx-user-city',name:'city',fieldLabel:_('city'),xtype:'textfield',anchor:'100%',maxLength:255},{id:'modx-user-state',name:'state',fieldLabel:_('user_state'),xtype:'textfield',width:100,maxLength:100},{id:'modx-user-zip',name:'zip',fieldLabel:_('user_zip'),xtype:'textfield',width:100,maxLength:25},{id:'modx-user-country',fieldLabel:_('user_country'),xtype:'modx-combo-country',value:''},{id:'modx-user-website',name:'website',fieldLabel:_('user_website'),xtype:'textfield',anchor:'100%',maxLength:255},{id:'modx-user-dob',name:'dob',fieldLabel:_('user_dob'),xtype:'datefield',width:200,allowBlank:true,format:MODx.config.manager_date_format},{id:'modx-user-gender',name:'gender',hiddenName:'gender',fieldLabel:_('user_gender'),xtype:'modx-combo-gender',width:200}]},{columnWidth:.5,defaults:{msgTarget:'under'},items:[{id:'modx-user-newpassword',name:'newpassword',xtype:'hidden',value:false},{id:'modx-user-primary-group',name:'primary_group',xtype:'hidden'},{id:'modx-user-active',name:'active',hideLabel:true,boxLabel:_('active'),description:_('user_active_desc'),xtype:'xcheckbox',inputValue:1},{id:'modx-user-sudo',name:'sudo',hideLabel:true,boxLabel:_('user_sudo'),description:_('user_sudo_desc'),xtype:'xcheckbox',inputValue:1,value:0},{id:'modx-user-blocked',name:'blocked',hideLabel:true,boxLabel:_('user_block'),description:_('user_block_desc'),xtype:'xcheckbox',inputValue:1},{id:'modx-user-blockeduntil',name:'blockeduntil',fieldLabel:_('user_blockeduntil'),description:_('user_blockeduntil_desc'),xtype:'xdatetime',width:300,timeWidth:150,dateWidth:150,allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,hiddenFormat:'Y-m-d H:i:s'},{id:'modx-user-blockedafter',name:'blockedafter',fieldLabel:_('user_blockedafter'),description:_('user_blockedafter_desc'),xtype:'xdatetime',width:300,timeWidth:150,dateWidth:150,allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,hiddenFormat:'Y-m-d H:i:s'},{id:'modx-user-logincount',name:'logincount',fieldLabel:_('user_logincount'),description:_('user_logincount_desc'),xtype:'statictextfield'},{id:'modx-user-lastlogin',name:'lastlogin',fieldLabel:_('user_prevlogin'),description:_('user_prevlogin_desc'),xtype:'statictextfield'},{id:'modx-user-failedlogincount',name:'failedlogincount',fieldLabel:_('user_failedlogincount'),description:_('user_failedlogincount_desc'),xtype:'textfield'},{id:'modx-user-class-key',name:'class_key',fieldLabel:_('class_key'),description:_('user_class_key_desc'),xtype:'textfield',anchor:'100%',value:'modUser'},{id:'modx-user-comment',name:'comment',fieldLabel:_('comment'),xtype:'textarea',anchor:'100%',grow:true},{id:'modx-user-fs-newpassword',title:_('password_new'),xtype:'fieldset',cls:'x-fieldset-checkbox-toggle',checkboxToggle:true,collapsed:(config.user?true:false),forceLayout:true,listeners:{'expand':{fn:function(p){Ext.getCmp('modx-user-newpassword').setValue(true);this.markDirty();},scope:this},'collapse':{fn:function(p){Ext.getCmp('modx-user-newpassword').setValue(false);this.markDirty();},scope:this}},items:[{xtype:'radiogroup',fieldLabel:_('password_method'),columns:1,items:[{id:'modx-user-passwordnotifymethod-e',name:'passwordnotifymethod',boxLabel:_('password_method_email'),xtype:'radio',value:'e',inputValue:'e'},{id:'modx-user-passwordnotifymethod-s',name:'passwordnotifymethod',boxLabel:_('password_method_screen'),xtype:'radio',value:'s',inputValue:'s',checked:true}]},{xtype:'radiogroup',fieldLabel:_('password_gen_method'),columns:1,items:[{id:'modx-user-password-genmethod-g',name:'passwordgenmethod',boxLabel:_('password_gen_gen'),xtype:'radio',inputValue:'g',value:'g',checked:true},{id:'modx-user-password-genmethod-s',name:'passwordgenmethod',boxLabel:_('password_gen_specify'),xtype:'radio',inputValue:'spec',value:'spec'}]},{id:'modx-user-panel-newpassword',xtype:'panel',layout:'form',border:false,autoHeight:true,style:'padding-top: 15px',items:[{id:'modx-user-specifiedpassword',name:'specifiedpassword',fieldLabel:_('change_password_new'),xtype:'textfield',inputType:'password',anchor:'100%'},{id:'modx-user-confirmpassword',name:'confirmpassword',fieldLabel:_('change_password_confirm'),xtype:'textfield',inputType:'password',anchor:'100%'}]}]}]}]},{html:MODx.onUserFormRender,border:false}];}});Ext.reg('modx-panel-user',MODx.panel.User);MODx.combo.Gender=function(config){config=config||{};Ext.applyIf(config,{store:new Ext.data.SimpleStore({fields:['d','v'],data:[['',0],[_('user_male'),1],[_('user_female'),2],[_('user_other'),3]]}),displayField:'d',valueField:'v',mode:'local',triggerAction:'all',editable:false,selectOnFocus:false});MODx.combo.Gender.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.Gender,Ext.form.ComboBox);Ext.reg('modx-combo-gender',MODx.combo.Gender);;MODx.page.UpdateUser=function(config){config=config||{};Ext.applyIf(config,{formpanel:'modx-panel-user',actions:{'new':'security/user/create',edit:'security/user/update',cancel:'security/user'},buttons:[{process:'security/user/update',text:_('save'),id:'modx-abtn-save',cls:'primary-button',method:'remote',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]},{text:_('cancel'),id:'modx-abtn-cancel',handler:function(){MODx.loadPage('security/user')}},{text:_('delete'),id:'modx-abtn-delete',handler:this.removeUser,scope:this},{text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane}],components:[{xtype:'modx-panel-user',renderTo:'modx-panel-user-div',user:config.user,remoteFields:config.remoteFields,extendedFields:config.extendedFields,name:''}]});MODx.page.UpdateUser.superclass.constructor.call(this,config);};Ext.extend(MODx.page.UpdateUser,MODx.Component,{removeUser:function(btn,e){MODx.msg.confirm({title:_('user_remove'),text:_('user_confirm_remove'),url:MODx.config.connector_url,params:{action:'security/user/delete',id:this.config.user},listeners:{'success':{fn:function(r){MODx.loadPage('security/user');},scope:this}}});}});Ext.reg('modx-page-user-update',MODx.page.UpdateUser);